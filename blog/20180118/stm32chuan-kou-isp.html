<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
  <meta charset="utf-8">
  <title>Stm32串口isp - 生命不息 折腾不止</title>
  <meta name="author" content="nicekwell">

  
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://nicekwell.net/blog/20180118/stm32chuan-kou-isp.html">
  <link href="/favicon.png" type="image/png" rel="icon">
  <link href="/atom.xml" rel="alternate" title="生命不息 折腾不止" type="application/atom+xml">

  <!-- http://opengraphprotocol.org/ -->
  <meta name="twitter:card" content="summary_large_image">
  <meta property="og:type" content="website">
  <meta property="og:url" content="http://nicekwell.net/blog/20180118/stm32chuan-kou-isp.html">
  <meta property="og:title" content="Stm32串口isp - 生命不息 折腾不止">
  

  <script src="/javascripts/libs/jquery/jquery-2.1.3.min.js"></script>

<link href="/assets/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="/assets/bootstrap/dist/css/bootstrap-theme.min.css" rel="stylesheet" type="text/css">

<!-- MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
  tex2jax: {
  inlineMath: [ ['$','$'], ["\\(","\\)"] ],
  processEscapes: true
  }
  });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
  tex2jax: {
  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  }
  });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for(i=0; i < all.length; i += 1) {
               all[i].SourceElement().parentNode.className += ' has-jax';
               }
               });
               </script><script type="text/javascript"   src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  
  <link href="/stylesheets/screen.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />
  

  
   <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-86729138-1', 'auto');
    ga('send', 'pageview');

  </script>


</head>

  <body   >
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="wrap">
      <header role="banner">
        <nav class="navbar navbar-default" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" title="toggle navbar" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">生命不息 折腾不止</a>
        </div>

        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li class="active">
                    <a rel="index" href="/">Blog</a>
                </li>
                <li >
                    <a href="/blog/archives">Archives</a>
                </li>
		<!-- <li > -->
                <!--     <a href="/pages/ping-heng-de-shi-jie.html">平衡的世界</a> -->
                <!-- </li> -->
		<li >
                    <a href="/pages/dan-pian-ji-bian-cheng.html">单片机编程</a>
                </li>
                <li >
                  <a href="/pages/raspberrypi.html">树莓派</a>
                </li>
		<!-- <li > -->
                <!--     <a href="/pages/diy.html">DIY</a> -->
                <!-- </li> -->
		<li >
                    <a href="/pages/about.html">About</a>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a class="subscribe-rss" href="/atom.xml" title="subscribe via RSS">
                        <span class="visible-xs">RSS</span>
                        <img class="hidden-xs" src="/images/rss.png" alt="RSS">
                    </a>
                </li>
                
            </ul>
            
                <form class="navbar-form navbar-right" action="https://www.google.com/search" method="GET">
                    <input type="hidden" name="sitesearch" value="nicekwell.net">
                    <div class="form-group">
                        <input class="form-control" type="text" name="q" placeholder="Search">
                    </div>
                </form>
            
        </div>
    </div>
</nav>


      </header>
      <div id="main" role="main" class="container">
        <div id="content">
          <div class="row">
  <div class="page-content col-md-9" itemscope itemtype="http://schema.org/Blog">
    <meta itemprop="name" content="生命不息 折腾不止" />
    
    <meta itemprop="url" content="http://nicekwell.net" />
    <article class="hentry" role="article" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
      
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2018-01-18T10:59:36+08:00"  data-updated="true" itemprop="datePublished dateCreated">2018年1月18日</time>
        
      </p>
    
    
    <h1 class="entry-title" itemprop="name headline">
        Stm32串口isp
        
    </h1>
    
  </header>


<div class="entry-content clearfix" itemprop="articleBody description"><ul id="markdown-toc">
  <li><a href="#section" id="markdown-toc-section">概述</a></li>
  <li><a href="#section-1" id="markdown-toc-section-1">广告</a></li>
  <li><a href="#section-2" id="markdown-toc-section-2">下载协议</a>    <ul>
      <li><a href="#section-3" id="markdown-toc-section-3">1、硬件</a></li>
      <li><a href="#sync" id="markdown-toc-sync">2、sync</a></li>
      <li><a href="#get-command" id="markdown-toc-get-command">3、get command</a></li>
      <li><a href="#get-version--read-protection" id="markdown-toc-get-version--read-protection">4、get version &amp; read protection</a></li>
      <li><a href="#get-id-command" id="markdown-toc-get-id-command">5、get ID command</a></li>
      <li><a href="#erase-memory-command" id="markdown-toc-erase-memory-command">6、Erase Memory command</a></li>
      <li><a href="#write-memory-command" id="markdown-toc-write-memory-command">7、Write Memory command</a></li>
      <li><a href="#read-memory-command" id="markdown-toc-read-memory-command">8、Read Memory command</a></li>
      <li><a href="#go-command" id="markdown-toc-go-command">9、Go command</a></li>
    </ul>
  </li>
  <li><a href="#section-4" id="markdown-toc-section-4">代码说明</a>    <ul>
      <li><a href="#section-5" id="markdown-toc-section-5">程序结构</a></li>
      <li><a href="#stm32isp" id="markdown-toc-stm32isp">stm32isp接口</a>        <ul>
          <li><a href="#stm32ispinit" id="markdown-toc-stm32ispinit">stm32isp_init</a></li>
          <li><a href="#stm32ispclose" id="markdown-toc-stm32ispclose">stm32isp_close</a></li>
          <li><a href="#stm32ispsync" id="markdown-toc-stm32ispsync">stm32isp_sync</a></li>
          <li><a href="#stm32ispgetcommand" id="markdown-toc-stm32ispgetcommand">stm32isp_get_command</a></li>
          <li><a href="#stm32ispgetidcommand" id="markdown-toc-stm32ispgetidcommand">stm32isp_get_ID_command</a></li>
          <li><a href="#stm32isperaseall" id="markdown-toc-stm32isperaseall">stm32isp_erase_all</a></li>
          <li><a href="#stm32ispwritebin" id="markdown-toc-stm32ispwritebin">stm32isp_write_bin</a></li>
          <li><a href="#stm32ispverify" id="markdown-toc-stm32ispverify">stm32isp_verify</a></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<p>  </p>

<p>这里介绍stm32串口isp实现方法，包含st官方协议整理和实现代码。</p>

<!-- more -->

<p>已提交到github <a href="https://github.com/nicekwell/stm32ISP">https://github.com/nicekwell/stm32ISP</a>，这里把工程README复制过来。</p>

<h1 id="section">概述</h1>

<p>stm32串口ISP程序，基于c语言。<br />
在ubuntu和mac下测试都ok，ubuntu下需要修改/dev/ttyUSB0权限，mac下不需要修改。<br />
本程序在stm32f103c8t6上ok，根据官方文档，其他型号单片机下载协议相同，但没有测试过。</p>

<p>使用方法：<br />
<strong>stm32isp /dev/ttyUSB0 stm32_test.bin</strong><br />
mac下的usb串口节点是 /dev/tty.usbserial</p>

<p>注：</p>

<ol>
  <li>波特率固定为57600不允许修改。实际上测试了各种波特率，只有57600和38400可以稳定下载（程序写的还不太稳定吧），所以波特率固定为了57600。</li>
  <li><strong>下载的是bin文件，不是hex文件</strong>。bin文件是纯粹的编码，hex文件包含了地址信息。keil默认不生成bin文件，生成bin文件的方法可网上查找。</li>
</ol>

<h1 id="section-1">广告</h1>

<p>老婆做毕业设计，给我下了死命令，一定要找300个程序员研究一下，请各位同行做个调查问卷，可扫描下面二维码或者直接点击此链接：<a href="https://www.wjx.cn/jq/17710478.aspx">https://www.wjx.cn/jq/17710478.aspx</a>，多谢！</p>

<p><img src="https://github.com/nicekwell/stm32ISP/raw/master/documents/ad.jpg" alt="ad.jpg" /></p>

<h1 id="section-2">下载协议</h1>

<p>stm32官方文档已提交到本工程 documents 目录下。<a href="https://github.com/nicekwell/stm32ISP/raw/master/documents/stm32isp%20application%20note.pdf">https://github.com/nicekwell/stm32ISP/raw/master/documents/stm32isp%20application%20note.pdf</a></p>

<h2 id="section-3">1、硬件</h2>
<p>首先要让stm32进入bootloader启动：</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">引脚</th>
      <th style="text-align: center">电平</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">BOOT0</td>
      <td style="text-align: center">高电平</td>
    </tr>
    <tr>
      <td style="text-align: center">BOOT1</td>
      <td style="text-align: center">低电平</td>
    </tr>
  </tbody>
</table>

<p>这样启动后就会从system分区启动，开始接收串口数据。</p>

<p>连接串口1：</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">引脚</th>
      <th style="text-align: center">功能</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">PA9</td>
      <td style="text-align: center">TXD，连接host RXD</td>
    </tr>
    <tr>
      <td style="text-align: center">PA10</td>
      <td style="text-align: center">RXD，连接host TXD</td>
    </tr>
  </tbody>
</table>

<h2 id="sync">2、sync</h2>
<p>以下数据指的是响应host或device端发送的数据。</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">host</th>
      <th style="text-align: center">device</th>
      <th style="text-align: center">note</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">0x7f</td>
      <td style="text-align: center">-</td>
      <td style="text-align: center">发送0x7f，单片机收到后会自动匹配波特率。</td>
    </tr>
    <tr>
      <td style="text-align: center">-</td>
      <td style="text-align: center">0x79(ACK)/0x1F(NACK)</td>
      <td style="text-align: center">device返回ACK或NACK，表示对host的反应。</td>
    </tr>
  </tbody>
</table>

<p>适配波特率这一步是无条件执行的，执行完这一步之后就可以接收各种指令。<br />
下面就介绍各个指令的功能和数据协议。</p>

<h2 id="get-command">3、get command</h2>

<p>在上面已经适配波特率情况下可以执行此指令。<br />
【指令码】0x00<br />
【功能】获取stm32里bootloader版本号，以及所有支持的指令代码。<br />
【数据协议】</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">host</th>
      <th style="text-align: center">device</th>
      <th style="text-align: center">note</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">0x00 + 0xff</td>
      <td style="text-align: center">-</td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td style="text-align: center">-</td>
      <td style="text-align: center">0x79(ACK)/0x1F(NACK)</td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td style="text-align: center">-</td>
      <td style="text-align: center">N</td>
      <td style="text-align: center">1字节，表示下面要接收到的字节数。bootloaderversion字节数 + 所有指令字节数 = N+1</td>
    </tr>
    <tr>
      <td style="text-align: center">-</td>
      <td style="text-align: center">bootloader version</td>
      <td style="text-align: center">1字节，如0x21代表2.1版本</td>
    </tr>
    <tr>
      <td style="text-align: center">-</td>
      <td style="text-align: center">所有支持的指令</td>
      <td style="text-align: center">多个字节，每个字节数据都表示一个支持的指令</td>
    </tr>
    <tr>
      <td style="text-align: center">-</td>
      <td style="text-align: center">0x79(ACK)/0x1F(NACK)</td>
      <td style="text-align: center">指令执行结束后会返回0x79</td>
    </tr>
  </tbody>
</table>

<h2 id="get-version--read-protection">4、get version &amp; read protection</h2>
<p>【指令码】0x01<br />
【功能】获取stm32里bootloader版本号，读取保护状态。<br />
【数据协议】</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">host</th>
      <th style="text-align: center">device</th>
      <th style="text-align: center">note</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">0x01+0xfe</td>
      <td style="text-align: center">-</td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td style="text-align: center">-</td>
      <td style="text-align: center">0x79(ACK)/0x1F(NACK)</td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td style="text-align: center">-</td>
      <td style="text-align: center">bootloader version</td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td style="text-align: center">-</td>
      <td style="text-align: center">2个字节</td>
      <td style="text-align: center">这两个字节和保护状态有关</td>
    </tr>
    <tr>
      <td style="text-align: center">-</td>
      <td style="text-align: center">0x79(ACK)/0x1F(NACK)</td>
      <td style="text-align: center"> </td>
    </tr>
  </tbody>
</table>

<h2 id="get-id-command">5、get ID command</h2>
<p>【指令码】0x02<br />
【功能】获取stm32 PID（product ID，不是芯片唯一识别码）。<br />
【数据协议】</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">host</th>
      <th style="text-align: center">device</th>
      <th style="text-align: center">note</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">0x02+0xfd</td>
      <td style="text-align: center">-</td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td style="text-align: center">-</td>
      <td style="text-align: center">0x79(ACK)/0x1F(NACK)</td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td style="text-align: center">-</td>
      <td style="text-align: center">N</td>
      <td style="text-align: center">1字节，表示下面 PID字节数 - 1</td>
    </tr>
    <tr>
      <td style="text-align: center">-</td>
      <td style="text-align: center">PID</td>
      <td style="text-align: center">多字节(上一个字节已指明字节数)，先传高位后传低位。我这次用的stm32f103c8t6是2字节。</td>
    </tr>
    <tr>
      <td style="text-align: center">-</td>
      <td style="text-align: center">0x79(ACK)/0x1F(NACK)</td>
      <td style="text-align: center"> </td>
    </tr>
  </tbody>
</table>

<h2 id="erase-memory-command">6、Erase Memory command</h2>
<p>【指令码】0x43<br />
【功能】擦除flash，可以全擦或擦除一部分，这里只介绍全擦。<br />
【数据协议】</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">host</th>
      <th style="text-align: center">device</th>
      <th style="text-align: center">note</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">0x43+0xbc</td>
      <td style="text-align: center">-</td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td style="text-align: center">-</td>
      <td style="text-align: center">0x79(ACK)/0x1F(NACK)</td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td style="text-align: center">0xff+0x00</td>
      <td style="text-align: center">-</td>
      <td style="text-align: center">这是全擦指令</td>
    </tr>
    <tr>
      <td style="text-align: center">-</td>
      <td style="text-align: center">0x79(ACK)/0x1F(NACK)</td>
      <td style="text-align: center"> </td>
    </tr>
  </tbody>
</table>

<h2 id="write-memory-command">7、Write Memory command</h2>
<p>【指令码】0x31<br />
【功能】<br />
写存储器，可以写任意的RAM、flash，我们写程序就用这个。<br />
【数据协议】</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">host</th>
      <th style="text-align: center">device</th>
      <th style="text-align: center">note</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">0x31+0xCE</td>
      <td style="text-align: center">-</td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td style="text-align: center">-</td>
      <td style="text-align: center">0x79(ACK)/0x1F(NACK)</td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td style="text-align: center">addr</td>
      <td style="text-align: center">-</td>
      <td style="text-align: center">4字节，下载地址。用户flash起始地址是0x08000000。<strong>先发高位，后发低位</strong></td>
    </tr>
    <tr>
      <td style="text-align: center">addr checksum</td>
      <td style="text-align: center">-</td>
      <td style="text-align: center">1字节，地址的checksum，就是上面4字节数据的异或。</td>
    </tr>
    <tr>
      <td style="text-align: center">-</td>
      <td style="text-align: center">0x79(ACK)/0x1F(NACK)</td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td style="text-align: center">count</td>
      <td style="text-align: center">-</td>
      <td style="text-align: center">1字节，表示后面将要传输的字节数，范围(0, 255]。<strong>字节数 = 这个值+1</strong>，也就是说最大传输256字节。</td>
    </tr>
    <tr>
      <td style="text-align: center">data</td>
      <td style="text-align: center">-</td>
      <td style="text-align: center">多字节，字节数 = count + 1，最大256字节。<strong>这里下载进去的是bin文件，不是hex。。</strong></td>
    </tr>
    <tr>
      <td style="text-align: center">checksum</td>
      <td style="text-align: center">-</td>
      <td style="text-align: center">1字节，上面的data数据，以及数据个数count的checksum。注意这里的checksum包含<strong>数据和个数</strong>。</td>
    </tr>
    <tr>
      <td style="text-align: center">-</td>
      <td style="text-align: center">0x79(ACK)/0x1F(NACK)</td>
      <td style="text-align: center"> </td>
    </tr>
  </tbody>
</table>

<p>注：</p>

<ol>
  <li>对于写flash，用户flash的起始地址是0x08000000。</li>
  <li>对于写flash，这里最多一次写256字节，写一个bin文件需要多次使用此协议写入。</li>
</ol>

<h2 id="read-memory-command">8、Read Memory command</h2>
<p>【指令码】0x11<br />
【功能】<br />
读取stm32内存，可以读取stm32任意地址的RAM、flash等数据。<br />
我们常在下载完成后把flash内容读取出来验证。<br />
【数据协议】</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">host</th>
      <th style="text-align: center">device</th>
      <th style="text-align: center">note</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">0x11+0xEE</td>
      <td style="text-align: center">0x79(ACK)/0x1F(NACK)</td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td style="text-align: center">addr</td>
      <td style="text-align: center">-</td>
      <td style="text-align: center">4字节，下载地址。用户flash起始地址是0x08000000。<strong>先发高位，后发低位</strong></td>
    </tr>
    <tr>
      <td style="text-align: center">addr checksum</td>
      <td style="text-align: center">-</td>
      <td style="text-align: center">1字节，地址的checksum，就是上面4字节数据的异或。</td>
    </tr>
    <tr>
      <td style="text-align: center">-</td>
      <td style="text-align: center">0x79(ACK)/0x1F(NACK)</td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td style="text-align: center">count</td>
      <td style="text-align: center">-</td>
      <td style="text-align: center">1字节，将要读取的数据个数，0~255。count+1就是将要读取的字节数，最多读取256字节。</td>
    </tr>
    <tr>
      <td style="text-align: center">checksum</td>
      <td style="text-align: center">-</td>
      <td style="text-align: center">1字节，count的按位取反。</td>
    </tr>
    <tr>
      <td style="text-align: center">-</td>
      <td style="text-align: center">0x79(ACK)/0x1F(NACK)</td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td style="text-align: center">-</td>
      <td style="text-align: center">data</td>
      <td style="text-align: center">count+1个字节，这就是要读取的数据。</td>
    </tr>
  </tbody>
</table>

<p>注：</p>

<ol>
  <li>对于读取flash，用户flash的起始地址是0x08000000。</li>
  <li>一次最多读取256字节，要读取大段内容就重复执行这个读取操作。</li>
</ol>

<h2 id="go-command">9、Go command</h2>
<p>略。</p>

<h1 id="section-4">代码说明</h1>
<p>根据上面的下载协议，封装成了模块，这里介绍本程序结构和模块的使用，以便移植到其他地方。</p>

<h2 id="section-5">程序结构</h2>

<p><strong>wiringSerial.c wiringSerial.h</strong><br />
串口驱动，在树莓派<a href="https://github.com/WiringPi/WiringPi">wiringPi</a>基础上修改，增加了数据块读写代码，增加了更多设置项。<br />
这部分驱动在mac、桌面ubuntu、树莓派上都可以使用。</p>

<p><strong>stm32isp.c stm32isp.h</strong><br />
下载逻辑代码，基于串口驱动，串口的打开、关闭操作也归于这部分控制。<br />
以上两个部分，serial完全归于stm32isp，外部使用stm32isp时不需要再管串口了。</p>

<p><strong>main.c</strong><br />
程序交互的实现，调用上面stm32isp接口实现下载。</p>

<p>下面着重介绍的是stm32isp部分的接口函数。</p>

<h2 id="stm32isp">stm32isp接口</h2>
<p>stm32isp使用前提是串口工作正常。</p>

<h3 id="stm32ispinit">stm32isp_init</h3>
<p><code>int stm32isp_init(const char *device, const int baud, const int databits, const int stopbits, const char parity, const int timeout);</code><br />
使用前需要先调用此函数，主要是完成串口初始化（串口的打开和关闭也交给stm32isp模块管理）。<br />
例：<code>stm32isp_init("/dev/ttyUSB0", 57600, 8, 1, 'N', 30);</code><br />
注：此驱动测试只有57600和38400两个波特率可以正常下载。</p>

<h3 id="stm32ispclose">stm32isp_close</h3>
<p><code>void stm32isp_close();     //成功返回1，失败返回0</code><br />
下载结束后调用此函数，主要是完成串口关闭（串口的打开和关闭也交给stm32isp模块管理）。</p>

<h3 id="stm32ispsync">stm32isp_sync</h3>
<p><code>int stm32isp_sync();</code><br />
同步波特率，成功返回1，失败返回0。
打开串口后第一步就需要sync，和单片机同步波特率。</p>

<h3 id="stm32ispgetcommand">stm32isp_get_command</h3>
<p><code>int stm32isp_get_command()</code><br />
获取ID和command列表，信息保存在驱动内部结构体，不输出，但会进行打印信息。成功返回1，失败返回0。<br />
这一步不是下载必须执行的。</p>

<h3 id="stm32ispgetidcommand">stm32isp_get_ID_command</h3>
<p><code>int stm32isp_get_ID_command();</code><br />
获取PID，信息保存在驱动内部结构体，不输出，但会进行打印。成功返回1，失败返回0。<br />
这一步不是下载必须执行的。</p>

<h3 id="stm32isperaseall">stm32isp_erase_all</h3>
<p><code>int stm32isp_erase_all();</code>
全擦flash，成功返回1，失败返回0。<br />
下载之前先擦除flash。</p>

<h3 id="stm32ispwritebin">stm32isp_write_bin</h3>
<p><code>int stm32isp_write_bin(char *p);</code><br />
传入bin文件路径，写入bin文件到flash，成功返回1，失败返回0。<br />
注意写入的是bin文件，不是hex文件。<br />
bin文件路径可能由main函数的argv参数传入。</p>

<h3 id="stm32ispverify">stm32isp_verify</h3>
<p><code>int stm32isp_verify(char *p);</code><br />
传入bin文件路径，根据bin文件大小读取flash相应大小内容，并把两个比较，验证成功返回1，失败返回0。<br />
这一步可选，为了保险可下载后验证一下。</p>

<hr />

<p>本站所有文章欢迎转载，但请保留作者信息和原文地址。</p>
</div>


      <footer>
        <p class="meta text-muted">
          
  

<span class="glyphicon glyphicon-user"></span> <span class="byline author vcard" itemprop="author" itemscope itemtype="http://schema.org/Person">Posted by <span class="fn" itemprop="name">nicekwell</span></span>

          












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2018-01-18T10:59:36+08:00"  data-updated="true" itemprop="datePublished dateCreated">2018年1月18日</time>
          

<span class="glyphicon glyphicon-tags"></span>&nbsp;
<span class="categories">
  
    <a class='category' href='/blog/categories/dan-pian-ji-bian-cheng/'>单片机编程</a>
  
</span>


        </p>
        
          <div class="sharing">
  
  
  
</div>

        
        
          <ul class="meta text-muted pager">
            
            <li class="previous"><a href="/blog/20171124/shu-mei-pai-wiringpi-wiringpi-cde-i2cku-shi-yong.html" title="Previous Post: 树莓派-wiringPi-wiringPi-C的i2c库使用">&laquo; 树莓派-wiringPi-wiringPi-C的i2c库使用</a></li>
            
            
          </ul>
        
      </footer>
    </article>
    
      <section>
        <h2>Comments</h2>
        <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
      </section>
    
  </div>

  
  <aside class="sidebar col-md-3">
    
      <section class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">文章目录</h3>
  </div>
  
  <div id="posts_menu" class="list-group">
    <a class="list-group-item " href="/pages/dan-pian-ji-bian-cheng.html">单片机编程</a>
    <a class="list-group-item " href="/pages/module-and-agreement.html">模块和协议</a>
    <a class="list-group-item " href="/pages/raspberrypi.html">树莓派</a>
    <a class="list-group-item " href="/pages/network-programming-and-server.html">网络编程和服务器</a>
    <a class="list-group-item " href="/pages/ping-heng-de-shi-jie.html">平衡的世界</a>
    <a class="list-group-item " href="/pages/diy.html">DIY</a>
  </div>
</section>
<section class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">近期文章</h3>
  </div>
  
  <div id="recent_posts" class="list-group">
    
    <a class="list-group-item active" href="/blog/20180118/stm32chuan-kou-isp.html">Stm32串口isp</a>
    
    <a class="list-group-item " href="/blog/20171124/shu-mei-pai-wiringpi-wiringpi-cde-i2cku-shi-yong.html">树莓派-wiringPi-wiringPi-C的i2c库使用</a>
    
    <a class="list-group-item " href="/blog/20171123/shu-mei-pai-wiringpi-shu-mei-pai-de-i2cpei-zhi.html">树莓派-wiringPi-树莓派的i2c配置</a>
    
    <a class="list-group-item " href="/blog/20171123/shu-mei-pai-wiringpi-uartchuan-kou.html">树莓派-wiringPi-UART串口</a>
    
    <a class="list-group-item " href="/blog/20171123/shu-mei-pai-wiringpi-you-xian-ji-and-zhong-duan-and-xian-cheng.html">树莓派-wiringPi-优先级&amp;中断&amp;线程</a>
    
    <a class="list-group-item " href="/blog/20171123/shu-mei-pai-wiringpi-shi-jian-han-shu.html">树莓派-wiringPi-时间函数</a>
    
    <a class="list-group-item " href="/blog/20171122/shu-mei-pai-wiringpi-gpio.html">树莓派-wiringPi-GPIO</a>
    
    <a class="list-group-item " href="/blog/20171122/shu-mei-pai-wiringpi-she-zhi-yin-jiao-bian-hao-mo-shi.html">树莓派-wiringPI-设置引脚编号模式</a>
    
    <a class="list-group-item " href="/blog/20171122/shu-mei-pai-wiringpi-bian-yi-and-tou-wen-jian-and-lib.html">树莓派-wiringPi-编译&amp;头文件&amp;lib</a>
    
    <a class="list-group-item " href="/blog/20171122/shu-mei-pai-wiringpi-shuo-ming-he-an-zhuang.html">树莓派-wiringPi-说明和安装</a>
    
    <a class="list-group-item " href="/blog/20171120/shu-mei-pai-pypi-uartchuan-kou.html">树莓派-pypi-UART串口</a>
    
    <a class="list-group-item " href="/blog/20171119/shu-mei-pai-pypi-gpio.html">树莓派-pypi-GPIO</a>
    
    <a class="list-group-item " href="/blog/20171116/shu-mei-pai-pypi-shuo-ming-he-an-zhuang.html">树莓派-pypi-说明和安装</a>
    
    <a class="list-group-item " href="/blog/20171115/shu-mei-pai-ying-jian-he-gong-neng-gong-hao.html">树莓派-硬件和功能-功耗</a>
    
    <a class="list-group-item " href="/blog/20171115/shu-mei-pai-ying-jian-he-gong-neng-ying-jian-he-gong-neng.html">树莓派-硬件和功能-硬件和功能</a>
    
  </div>
</section>





<section class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">友情链接</h3>
  </div>
  
  <div id="link" class="list-group">
    <a class="list-group-item " href="http://www.diy-robots.com/">动力老男孩</a>
    <a class="list-group-item " href="http://blog.sina.com.cn/u/1907350525">老薛</a>
    <a class="list-group-item " href="http://www.muwenyidao.com/">木文一刀</a>
    <a class="list-group-item " href="http://blog.leafsoar.com/">无间落叶</a>
    <a class="list-group-item " href="http://www.chuangkoo.com/">创库</a>
    <a class="list-group-item " href="http://www.guokr.com/group/27/">果壳DIY</a>
  </div>
</section>

    
  </aside>
  
</div>

        </div>
      </div>
    </div>
    <footer role="contentinfo"><div class="container">
    <p class="text-muted credits">
  Copyright &copy; 2018 - nicekwell<br>
  <small>
      <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>,
      <span class="credit">customized with <a href="https://github.com/kAworu/octostrap3">octostrap3</a></span>.
  </small>
</p>

</div>
</footer>
    

<script type="text/javascript">
      var disqus_shortname = 'nicekwell';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://nicekwell.net/blog/20180118/stm32chuan-kou-isp.html';
        var disqus_url = 'http://nicekwell.net/blog/20180118/stm32chuan-kou-isp.html';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>








<script src="/assets/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/javascripts/modernizr.js"></script>


  </body>
</html>
