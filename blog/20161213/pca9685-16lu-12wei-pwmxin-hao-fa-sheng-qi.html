<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
  <meta charset="utf-8">
  <title>PCA9685 16路12位pwm信号发生器 - 生命不息 折腾不止</title>
  <meta name="author" content="nicekwell">

  
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://nicekwell.net/blog/20161213/pca9685-16lu-12wei-pwmxin-hao-fa-sheng-qi.html">
  <link href="/favicon.png" type="image/png" rel="icon">
  <link href="/atom.xml" rel="alternate" title="生命不息 折腾不止" type="application/atom+xml">

  <!-- http://opengraphprotocol.org/ -->
  <meta name="twitter:card" content="summary_large_image">
  <meta property="og:type" content="website">
  <meta property="og:url" content="http://nicekwell.net/blog/20161213/pca9685-16lu-12wei-pwmxin-hao-fa-sheng-qi.html">
  <meta property="og:title" content="PCA9685 16路12位pwm信号发生器 - 生命不息 折腾不止">
  

  <script src="/javascripts/libs/jquery/jquery-2.1.3.min.js"></script>

<link href="/assets/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="/assets/bootstrap/dist/css/bootstrap-theme.min.css" rel="stylesheet" type="text/css">

<!-- MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
  tex2jax: {
  inlineMath: [ ['$','$'], ["\\(","\\)"] ],
  processEscapes: true
  }
  });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
  tex2jax: {
  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  }
  });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for(i=0; i < all.length; i += 1) {
               all[i].SourceElement().parentNode.className += ' has-jax';
               }
               });
               </script><script type="text/javascript"   src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  
  <link href="/stylesheets/screen.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />
  

  
   <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-86729138-1', 'auto');
    ga('send', 'pageview');

  </script>


</head>

  <body   >
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="wrap">
      <header role="banner">
        <nav class="navbar navbar-default" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" title="toggle navbar" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">生命不息 折腾不止</a>
        </div>

        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li class="active">
                    <a rel="index" href="/">Blog</a>
                </li>
                <li >
                    <a href="/blog/archives">Archives</a>
                </li>
		<!-- <li > -->
                <!--     <a href="/pages/ping-heng-de-shi-jie.html">平衡的世界</a> -->
                <!-- </li> -->
		<li >
                    <a href="/pages/dan-pian-ji-bian-cheng.html">单片机编程</a>
                </li>
                <li >
                  <a href="/pages/raspberrypi.html">树莓派</a>
                </li>
		<!-- <li > -->
                <!--     <a href="/pages/diy.html">DIY</a> -->
                <!-- </li> -->
		<li >
                    <a href="/pages/about.html">About</a>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a class="subscribe-rss" href="/atom.xml" title="subscribe via RSS">
                        <span class="visible-xs">RSS</span>
                        <img class="hidden-xs" src="/images/rss.png" alt="RSS">
                    </a>
                </li>
                
            </ul>
            
                <form class="navbar-form navbar-right" action="https://www.google.com/search" method="GET">
                    <input type="hidden" name="sitesearch" value="nicekwell.net">
                    <div class="form-group">
                        <input class="form-control" type="text" name="q" placeholder="Search">
                    </div>
                </form>
            
        </div>
    </div>
</nav>


      </header>
      <div id="main" role="main" class="container">
        <div id="content">
          <div class="row">
  <div class="page-content col-md-9" itemscope itemtype="http://schema.org/Blog">
    <meta itemprop="name" content="生命不息 折腾不止" />
    
    <meta itemprop="url" content="http://nicekwell.net" />
    <article class="hentry" role="article" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
      
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2016-12-13T20:24:30+08:00"  data-updated="true" itemprop="datePublished dateCreated">2016年12月13日</time>
        
      </p>
    
    
    <h1 class="entry-title" itemprop="name headline">
        PCA9685 16路12位pwm信号发生器
        
    </h1>
    
  </header>


<div class="entry-content clearfix" itemprop="articleBody description"><ul id="markdown-toc">
  <li><a href="#section" id="markdown-toc-section">一、概述和硬件</a>    <ul>
      <li><a href="#section-1" id="markdown-toc-section-1">1、概述</a></li>
      <li><a href="#section-2" id="markdown-toc-section-2">2、硬件</a>        <ul>
          <li><a href="#section-3" id="markdown-toc-section-3">1、电压</a></li>
          <li><a href="#i2c" id="markdown-toc-i2c">2、i2c地址</a></li>
          <li><a href="#section-4" id="markdown-toc-section-4">3、使能脚</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#section-5" id="markdown-toc-section-5">二、寄存器功能</a>    <ul>
      <li><a href="#mode1" id="markdown-toc-mode1">MODE1寄存器</a></li>
      <li><a href="#onoff" id="markdown-toc-onoff">各个通道的ON和OFF寄存器</a></li>
      <li><a href="#prescale" id="markdown-toc-prescale">PRE_SCALE寄存器</a></li>
    </ul>
  </li>
  <li><a href="#section-6" id="markdown-toc-section-6">三、驱动</a>    <ul>
      <li><a href="#wiringpi" id="markdown-toc-wiringpi">树莓派wiringPi平台</a></li>
    </ul>
  </li>
  <li><a href="#section-7" id="markdown-toc-section-7">四、使用流程</a></li>
</ul>
<p>  </p>

<p>16路12位PWM信号发生器，可用于控制舵机、led、电机等设备，i2c通信，节省主机资源。</p>

<p><img src="/images/module-and-agreement/pca9685.png" alt="pca9685" /></p>

<!-- more -->

<h1 id="section">一、概述和硬件</h1>

<h2 id="section-1">1、概述</h2>
<p>数据手册从网上找一下很容易找到（比如<a href="http://www2.ic37.com/pdf/pdf_download.asp?id=11155998_602380">http://www2.ic37.com/pdf/pdf_download.asp?id=11155998_602380</a>），但没有找到中文版，本文记录的是我使用中总结的内容和方法。</p>

<p>很常见的模块板子如上图所示，这个板子也比较便宜，十几块钱一个。<br />
i2c通信，只需要几根i2c线就可以控制16路pwm，周期和占空比都可控。<br />
可以多个模块级联。<br />
可控制16路通道的四种工作模式：关、开、pwm、可变pwm。<br />
精度是12位：</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">工作频率</th>
      <th style="text-align: center">时间分辨率</th>
      <th style="text-align: center">通常舵机500~2500us可分成份数</th>
      <th style="text-align: center">通常舵机500~2500us，旋转角180°的角度分辨率</th>
      <th style="text-align: center">对于电调，500us对应100%的占空比分辨率</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">50Hz</td>
      <td style="text-align: center">4.88us</td>
      <td style="text-align: center">410份</td>
      <td style="text-align: center">0.439°</td>
      <td style="text-align: center">0.976%≈1%（约100份）</td>
    </tr>
    <tr>
      <td style="text-align: center">60Hz</td>
      <td style="text-align: center">4us</td>
      <td style="text-align: center">492份</td>
      <td style="text-align: center">0.366°</td>
      <td style="text-align: center">0.8%（125份）</td>
    </tr>
  </tbody>
</table>

<p>驱动方式可以选择开漏输出或推挽输出。</p>

<h2 id="section-2">2、硬件</h2>

<h3 id="section-3">1、电压</h3>
<p>数字电路电压范围可接受3.3和5v电平。<br />
此外还有一个v+引脚，这个引脚是给舵机供电用的，可以接稍微高一点的电压。</p>

<h3 id="i2c">2、i2c地址</h3>
<p>有6个地址控制脚，通过这些引脚可以控制设备的i2c地址。<br />
<strong>7位的I2C地址为：0x40 + A5:A0</strong>，A5到A0如果不做任何处理的话是0，想要把哪一位置1就把那个引脚焊到一起。<br />
另外用i2cdetect检测出还有一个<strong>0x70</strong>地址一直存在，这是一个通用地址，可以给所有从机下达指令。</p>

<h3 id="section-4">3、使能脚</h3>
<p>模块有一个OE反使能脚，这个引脚低电平使能，不接的话模块内部默认已经接地使能了，所以正常使用可以不接。</p>

<h1 id="section-5">二、寄存器功能</h1>

<table>
  <thead>
    <tr>
      <th style="text-align: center">内部地址(hex)</th>
      <th style="text-align: center">名称</th>
      <th style="text-align: center">功能</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">00</td>
      <td style="text-align: center">MODE1</td>
      <td style="text-align: center">设置寄存器1</td>
    </tr>
    <tr>
      <td style="text-align: center">01</td>
      <td style="text-align: center">MODE2</td>
      <td style="text-align: center">设置寄存器2</td>
    </tr>
    <tr>
      <td style="text-align: center">02</td>
      <td style="text-align: center">SUBADR1</td>
      <td style="text-align: center">i2c-bus subaddress1</td>
    </tr>
    <tr>
      <td style="text-align: center">03</td>
      <td style="text-align: center">SUBADR2</td>
      <td style="text-align: center">i2c-bus subaddress2</td>
    </tr>
    <tr>
      <td style="text-align: center">04</td>
      <td style="text-align: center">SUBADR3</td>
      <td style="text-align: center">i2c-bus subaddress3</td>
    </tr>
    <tr>
      <td style="text-align: center">05</td>
      <td style="text-align: center">ALLCALLADR</td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td style="text-align: center">06</td>
      <td style="text-align: center">LED0_ON_L</td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td style="text-align: center">07</td>
      <td style="text-align: center">LED0_ON_H</td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td style="text-align: center">08</td>
      <td style="text-align: center">LED0_OFF_L</td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td style="text-align: center">09</td>
      <td style="text-align: center">LED0_OFF_H</td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td style="text-align: center">…</td>
      <td style="text-align: center">…</td>
      <td style="text-align: center">…</td>
    </tr>
    <tr>
      <td style="text-align: center">0x06 + 4*X</td>
      <td style="text-align: center">LEDX_ON_L</td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td style="text-align: center">0x06 + 4*X + 1</td>
      <td style="text-align: center">LEDX_ON_H</td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td style="text-align: center">0x06 + 4*X + 2</td>
      <td style="text-align: center">LEDX_OFF_L</td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td style="text-align: center">0x06 + 4*X + 3</td>
      <td style="text-align: center">LEDX_OFF_H</td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td style="text-align: center">…</td>
      <td style="text-align: center">…</td>
      <td style="text-align: center">…	上面共16路通道</td>
    </tr>
    <tr>
      <td style="text-align: center">FA</td>
      <td style="text-align: center">ALL_LED_ON_L</td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td style="text-align: center">FB</td>
      <td style="text-align: center">ALL_LED_ON_H</td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td style="text-align: center">FC</td>
      <td style="text-align: center">ALL_LED_OFF_L</td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td style="text-align: center">FD</td>
      <td style="text-align: center">ALL_LED_OFF_H</td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td style="text-align: center">FE</td>
      <td style="text-align: center">PRE_SCALE</td>
      <td style="text-align: center">控制周期的寄存器</td>
    </tr>
    <tr>
      <td style="text-align: center">FF</td>
      <td style="text-align: center">TestMode</td>
      <td style="text-align: center"> </td>
    </tr>
  </tbody>
</table>

<h2 id="mode1">MODE1寄存器</h2>

<table>
  <thead>
    <tr>
      <th style="text-align: center">位</th>
      <th style="text-align: center">名称</th>
      <th style="text-align: center">功能</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">D7</td>
      <td style="text-align: center">RESTART</td>
      <td style="text-align: center">写1复位，写完后此位自动清除。<strong>一定要在SLEEP位写0后至少500us后才能对此位写1进行复位。</strong></td>
    </tr>
    <tr>
      <td style="text-align: center">D6</td>
      <td style="text-align: center">EXTCLOCK</td>
      <td style="text-align: center">0-使用内部时钟（25MHz）。1-使用外部时钟引脚的时钟。<strong>修改此位前，一定要先SLEEP，再修改此位（此时SLEEP位仍然写1），再退出SLEEP。</strong></td>
    </tr>
    <tr>
      <td style="text-align: center">D5</td>
      <td style="text-align: center">AI</td>
      <td style="text-align: center">0-内部地址读写后不自动增加。1-内部地址读写后自动增加。一般i2c设备在对从机读写后内部地址都会自动增加，这个芯片可以手动设置是否自动增加，我们一般都会设成自动增加。</td>
    </tr>
    <tr>
      <td style="text-align: center">D4</td>
      <td style="text-align: center">SLEEP</td>
      <td style="text-align: center">0-退出SLEEP模式。1-进入SLEEP模式。注：1、写0退出sleep模式后，最多等500us后即可产生稳定的时钟信号。2、写1进入sleep模式后，时钟会关闭。此时可以修改时钟源寄存器EXTCLOCK和周期寄存器PRE_SCALE，修改这两个寄存器之前必须先进入sleep模式。</td>
    </tr>
    <tr>
      <td style="text-align: center">D3</td>
      <td style="text-align: center">SUB1</td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td style="text-align: center">D2</td>
      <td style="text-align: center">SUB2</td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td style="text-align: center">D1</td>
      <td style="text-align: center">SUB3</td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td style="text-align: center">D0</td>
      <td style="text-align: center">ALLCALL</td>
      <td style="text-align: center">0-不响应0x70通用i2c地址。1-响应0x70通用i2c地址。这个芯片除了可以通过A5:A0自定义i2c地址外，还有一个通用i2c地址0x70，此寄存器可以控制是否响应这个通用地址。注意啊：这个寄存器的设置好像掉电会保存的！</td>
    </tr>
  </tbody>
</table>

<h2 id="onoff">各个通道的ON和OFF寄存器</h2>
<p>总共16个通道，每个通道都有 LEDX_ON_L、LEDX_ON_H、LEDX_OFF_L、LEDX_OFF_H 四个寄存器。<br />
系统中有一个12位的计数ACK，ACK根据PRE_SCALE寄存器设置的周期进行增加，没增加一次就会和上述四个寄存器对比：<br />
<strong>当发现 ACK == LEDX_ON_H[3:0]:LEDX_ON_L 时，X通道输出高电平；<br />
当发现 ACK == LEDX_OFF_H[3:0]:LEDX_OFF_L 时，X通道输出低电平。</strong></p>

<h2 id="prescale">PRE_SCALE寄存器</h2>
<p>这个寄存器是用来设置周期的，具体原理可以不用管，只要记住这个公式：</p>

<p><img src="/images/module-and-agreement/prescale.png" alt="prescale" /></p>

<p>其中osc_clock是时钟，根据上面的寄存器设置选择是内部25MHz时钟还是外部时钟；<br />
update_rate是频率，比如周期是20ms，那么频率就是50。<br />
注意：<strong>实际应用中发现有误差，需要加入校准，要把udpate_rate乘以0.915。</strong><br />
包括从网上下载的arduino驱动中也加入了此校准。</p>

<h1 id="section-6">三、驱动</h1>

<p>网上可以找到arduino平台的驱动，我在在这里是用树莓派驱动的，介绍一下基于树莓派wiringPi库的驱动。</p>

<h2 id="wiringpi">树莓派wiringPi平台</h2>
<p>这里是基于树莓派wiringPi提供的i2c通信接口基础上实现的驱动，在其他平台上的驱动方法类似，只要把这里的i2c接口换成其他平台的通信接口即可。<br />
本驱动周期固定为20ms不可变，如需修改也非常容易。</p>

<p>pca9685_wiringpi.h文件：</p>

<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class=""><span class="line">/*
</span><span class="line">  这个驱动是在树莓派的wiringPi基础上的，基于wiringPi对i2c的接口函数。
</span><span class="line">  此驱动的使用方法是：
</span><span class="line">  1、先用 pca9685_init(从机地址) 初始化，得到一个设备描述符（int型），这个设备描述符代表这个pca9685芯片，因为可能多个pca9685级联，通过这个设备描述符来区分它们。
</span><span class="line">    它的
</span><span class="line">  2、调用 pca9685_setmk
</span><span class="line"> */
</span><span class="line">
</span><span class="line">#ifndef PCA9685_WIRINGPI_H
</span><span class="line">#define PCA9685_WIRINGPI_H
</span><span class="line">#include &lt;wiringPi.h&gt;
</span><span class="line">
</span><span class="line">int pca9685_init(unsigned char addr);	// addr是7位的i2c从机地址，返回的是linux标准的设备描述符，调用它的地方视作pca9685的设备描述符
</span><span class="line">					//因为可以多个pca9685级联，通过设备描述符区别它们
</span><span class="line">					//此驱动仅作为驱动舵机使用，周期固定死位20ms，不允许外部设置
</span><span class="line">void pca9685_setmk(int fd, int num, int mk);	//设置指定通道的脉宽。fd是在pca9685_init时获得的设备描述符，num是通道号（从0开始），mk是脉宽单位是us。周期已经固定为20ms了
</span><span class="line">
</span><span class="line">#endif</span></code></pre></td></tr></table></div></figure>
<p>pca9685_wiringpi.c文件：</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
</pre></td><td class="code"><pre><code class=""><span class="line">#include "pca9685_wiringpi.h"
</span><span class="line">
</span><span class="line">#define PCA9685_SUBADR1 0x2
</span><span class="line">#define PCA9685_SUBADR2 0x3
</span><span class="line">#define PCA9685_SUBADR3 0x4
</span><span class="line">
</span><span class="line">#define PCA9685_MODE1 0x0
</span><span class="line">#define PCA9685_PRESCALE 0xFE
</span><span class="line">
</span><span class="line">#define LED0_ON_L 0x6
</span><span class="line">#define LED0_ON_H 0x7
</span><span class="line">#define LED0_OFF_L 0x8
</span><span class="line">#define LED0_OFF_H 0x9
</span><span class="line">
</span><span class="line">#define ALLLED_ON_L 0xFA
</span><span class="line">#define ALLLED_ON_H 0xFB
</span><span class="line">#define ALLLED_OFF_L 0xFC
</span><span class="line">#define ALLLED_OFF_H 0xFD
</span><span class="line">
</span><span class="line">int pca9685_init(unsigned char addr)	// addr是7位的i2c从机地址，返回的是linux标准的设备描述符，调用它的地方视作pca9685的设备描述符
</span><span class="line">					//因为可以多个pca9685级联，通过设备描述符区别它们
</span><span class="line">					//此驱动仅作为驱动舵机使用，周期固定死位20ms，不允许外部设置
</span><span class="line">{
</span><span class="line">    int pca9685;
</span><span class="line">    pca9685 = wiringPiI2CSetup(addr);
</span><span class="line">
</span><span class="line">    {	//初始化pca9685芯片
</span><span class="line">	double T = 20000;	//周期，单位是us
</span><span class="line">	unsigned char prescale;
</span><span class="line">	double osc_clock = 25000000;
</span><span class="line">	unsigned char oldmode, newmode;
</span><span class="line">	T /= 0.915;	//不知道为什么，会有所偏差，这里校准一下就ok了，从网上找的arduino代码也进行了校准。
</span><span class="line">	T /= 1000000;	//把T转换成秒
</span><span class="line">	prescale = (unsigned char)(osc_clock/4096*T - 1);
</span><span class="line">//	printf("prescale = 0x%x", prescale);
</span><span class="line">	oldmode = wiringPiI2CReadReg8(pca9685, PCA9685_MODE1);
</span><span class="line">	newmode = (oldmode&amp;0x7f) | 0x10;	//准备进入sleep，设置时钟前必须先进入sleep模式
</span><span class="line">	wiringPiI2CWriteReg8(pca9685, PCA9685_MODE1, newmode);
</span><span class="line">	wiringPiI2CWriteReg8(pca9685, PCA9685_PRESCALE, prescale);
</span><span class="line">	oldmode &amp;= 0xef;	//清除sleep位
</span><span class="line">	wiringPiI2CWriteReg8(pca9685, PCA9685_MODE1, oldmode);
</span><span class="line">	delay(0.005);
</span><span class="line">	wiringPiI2CWriteReg8(pca9685, PCA9685_MODE1, oldmode | 0xa1);
</span><span class="line">    }
</span><span class="line">    
</span><span class="line">    return pca9685;
</span><span class="line">}
</span><span class="line">
</span><span class="line">void pca9685_setmk(int fd, int num, int mk)	//设置指定通道的脉宽。fd是在pca9685_init时获得的设备描述符，num是通道号（从0开始），mk是脉宽单位是us。周期已经固定为20ms了
</span><span class="line">{
</span><span class="line">    unsigned int ON, OFF;
</span><span class="line">    ON = 0;	//每次周期一开始就输出高电平
</span><span class="line">    OFF = (unsigned int)((((double)mk)/20000 * 4096)*1.0067114);	//最后的1.0067114是校准用的
</span><span class="line">//    printf("off = 0x%x", OFF);
</span><span class="line">
</span><span class="line">    wiringPiI2CWriteReg16(fd, LED0_ON_L+4*num, ON);
</span><span class="line">    wiringPiI2CWriteReg16(fd, LED0_OFF_L+4*num, OFF);
</span><span class="line">}</span></code></pre></td></tr></table></div></figure>

<p>关于驱动在树莓派上的速度：</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">树莓派设置的i2c波特率</th>
      <th style="text-align: center">设置16路通道所用时间</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">100000</td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td style="text-align: center">1000000(1M)</td>
      <td style="text-align: center">2067us</td>
    </tr>
    <tr>
      <td style="text-align: center">2000000(2M)</td>
      <td style="text-align: center">1300us</td>
    </tr>
  </tbody>
</table>

<h1 id="section-7">四、使用流程</h1>
<p>1、确定i2c地址<br />
通过焊接A5~A0确定模块的i2c地址，如果不做任何焊接，默认地址是0x40。<br />
2、连接数字电路电源。<br />
3、连接两根i2c线。<br />
4、连接v+引脚，给舵机供电电源。<br />
5、把驱动合入到工程，即可使用。</p>

<hr />

<p>本站所有文章欢迎转载，但请保留作者信息和原文地址。</p>

</div>


      <footer>
        <p class="meta text-muted">
          
  

<span class="glyphicon glyphicon-user"></span> <span class="byline author vcard" itemprop="author" itemscope itemtype="http://schema.org/Person">Posted by <span class="fn" itemprop="name">nicekwell</span></span>

          












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2016-12-13T20:24:30+08:00"  data-updated="true" itemprop="datePublished dateCreated">2016年12月13日</time>
          

<span class="glyphicon glyphicon-tags"></span>&nbsp;
<span class="categories">
  
    <a class='category' href='/blog/categories/mo-kuai-he-xie-yi/'>模块和协议</a>
  
</span>


        </p>
        
          <div class="sharing">
  
  
  
</div>

        
        
          <ul class="meta text-muted pager">
            
            <li class="previous"><a href="/blog/20161008/bie-cai-bai-kuai-er-bot.html" title="Previous Post: 别踩白块儿bot">&laquo; 别踩白块儿bot</a></li>
            
            
            <li class="next"><a href="/blog/20161223/ppmxin-hao-jie-shao.html" title="Next Post: PPM信号介绍">PPM信号介绍 &raquo;</a></li>
            
          </ul>
        
      </footer>
    </article>
    
      <section>
        <h2>Comments</h2>
        <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
      </section>
    
  </div>

  
  <aside class="sidebar col-md-3">
    
      <section class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">文章目录</h3>
  </div>
  
  <div id="posts_menu" class="list-group">
    <a class="list-group-item " href="/pages/dan-pian-ji-bian-cheng.html">单片机编程</a>
    <a class="list-group-item " href="/pages/module-and-agreement.html">模块和协议</a>
    <a class="list-group-item " href="/pages/raspberrypi.html">树莓派</a>
    <a class="list-group-item " href="/pages/network-programming-and-server.html">网络编程和服务器</a>
    <a class="list-group-item " href="/pages/ping-heng-de-shi-jie.html">平衡的世界</a>
    <a class="list-group-item " href="/pages/diy.html">DIY</a>
  </div>
</section>
<section class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">近期文章</h3>
  </div>
  
  <div id="recent_posts" class="list-group">
    
    <a class="list-group-item " href="/blog/20180118/zi-xing-che-ping-heng-yuan-li.html">自行车平衡原理</a>
    
    <a class="list-group-item " href="/blog/20180118/stm32chuan-kou-isp.html">Stm32串口isp</a>
    
    <a class="list-group-item " href="/blog/20171124/shu-mei-pai-wiringpi-wiringpi-cde-i2cku-shi-yong.html">树莓派-wiringPi-wiringPi-C的i2c库使用</a>
    
    <a class="list-group-item " href="/blog/20171123/shu-mei-pai-wiringpi-shu-mei-pai-de-i2cpei-zhi.html">树莓派-wiringPi-树莓派的i2c配置</a>
    
    <a class="list-group-item " href="/blog/20171123/shu-mei-pai-wiringpi-uartchuan-kou.html">树莓派-wiringPi-UART串口</a>
    
    <a class="list-group-item " href="/blog/20171123/shu-mei-pai-wiringpi-you-xian-ji-and-zhong-duan-and-xian-cheng.html">树莓派-wiringPi-优先级&amp;中断&amp;线程</a>
    
    <a class="list-group-item " href="/blog/20171123/shu-mei-pai-wiringpi-shi-jian-han-shu.html">树莓派-wiringPi-时间函数</a>
    
    <a class="list-group-item " href="/blog/20171122/shu-mei-pai-wiringpi-gpio.html">树莓派-wiringPi-GPIO</a>
    
    <a class="list-group-item " href="/blog/20171122/shu-mei-pai-wiringpi-she-zhi-yin-jiao-bian-hao-mo-shi.html">树莓派-wiringPI-设置引脚编号模式</a>
    
    <a class="list-group-item " href="/blog/20171122/shu-mei-pai-wiringpi-bian-yi-and-tou-wen-jian-and-lib.html">树莓派-wiringPi-编译&amp;头文件&amp;lib</a>
    
    <a class="list-group-item " href="/blog/20171122/shu-mei-pai-wiringpi-shuo-ming-he-an-zhuang.html">树莓派-wiringPi-说明和安装</a>
    
    <a class="list-group-item " href="/blog/20171120/shu-mei-pai-pypi-uartchuan-kou.html">树莓派-pypi-UART串口</a>
    
    <a class="list-group-item " href="/blog/20171119/shu-mei-pai-pypi-gpio.html">树莓派-pypi-GPIO</a>
    
    <a class="list-group-item " href="/blog/20171116/shu-mei-pai-pypi-shuo-ming-he-an-zhuang.html">树莓派-pypi-说明和安装</a>
    
    <a class="list-group-item " href="/blog/20171115/shu-mei-pai-ying-jian-he-gong-neng-gong-hao.html">树莓派-硬件和功能-功耗</a>
    
  </div>
</section>





<section class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">友情链接</h3>
  </div>
  
  <div id="link" class="list-group">
    <a class="list-group-item " href="http://www.diy-robots.com/">动力老男孩</a>
    <a class="list-group-item " href="http://blog.sina.com.cn/u/1907350525">老薛</a>
    <a class="list-group-item " href="http://www.muwenyidao.com/">木文一刀</a>
    <a class="list-group-item " href="http://blog.leafsoar.com/">无间落叶</a>
    <a class="list-group-item " href="http://www.chuangkoo.com/">创库</a>
    <a class="list-group-item " href="http://www.guokr.com/group/27/">果壳DIY</a>
  </div>
</section>

    
  </aside>
  
</div>

        </div>
      </div>
    </div>
    <footer role="contentinfo"><div class="container">
    <p class="text-muted credits">
  Copyright &copy; 2018 - nicekwell<br>
  <small>
      <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>,
      <span class="credit">customized with <a href="https://github.com/kAworu/octostrap3">octostrap3</a></span>.
  </small>
</p>

</div>
</footer>
    

<script type="text/javascript">
      var disqus_shortname = 'nicekwell';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://nicekwell.net/blog/20161213/pca9685-16lu-12wei-pwmxin-hao-fa-sheng-qi.html';
        var disqus_url = 'http://nicekwell.net/blog/20161213/pca9685-16lu-12wei-pwmxin-hao-fa-sheng-qi.html';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>








<script src="/assets/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/javascripts/modernizr.js"></script>


  </body>
</html>
